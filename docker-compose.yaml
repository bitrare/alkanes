version: "3.3"
volumes:
  bitcoin-data:
services:
  bitcoind:
    image: bitcoind:alkanes
    build:
      dockerfile: docker/Dockerfile.bitcoind
      context: ./
    volumes:
      - bitcoin-data:/root/.bitcoin
    command:
      ["-txindex", "-regtest=1", "-printtoconsole", "-rpcallowip=0.0.0.0/0", "-rpcbind=0.0.0.0", "-rpcuser=bitcoinrpc", "-rpcpassword=bitcoinrpc"]
    ports:
      - 18555:18443
      - 18444:18444
    restart: unless-stopped
  keydb:
    ports:
      - 7777:6379
    image: keydb:alkanes
    build:
      dockerfile: docker/Dockerfile.keydb
      context: ./
    command:
      [
        "keydb-server",
        "/etc/keydb/keydb.conf",
        "--storage-provider",
        "flash",
        "/data/flash",
        "--appendonly",
        "yes",
        "--maxmemory-policy",
        "allkeys-lru",
        "--bind",
        "0.0.0.0",
      ]
    restart: unless-stopped
  metashrew:
    build:
      dockerfile: docker/Dockerfile.indexer
      context: ./
    image: metashrew:alkanes
    environment:
      DAEMON_RPC_ADDR: http://bitcoind:18443
      AUTH: bitcoinrpc:bitcoinrpc
      REDIS_URL: redis://keydb:6379
#      LOG_FILTERS: none,metashrew_keydb=debug
    restart: unless-stopped
  jsonrpc:
    build:
      dockerfile: docker/Dockerfile.jsonrpc
      context: ./
    image: jsonrpc:alkanes
    environment:
      HOST: 0.0.0.0
      RPCUSER: bitcoinrpc
      RPCPASSWORD: bitcoinrpc
      DAEMON_RPC_ADDR: bitcoind:18443
      ORD_HOST: ord
      ORD_PORT: 8090
      ESPLORA_HOST: esplora
      ESPLORA_PORT: 50010
      PORT: 18888
    ports:
      - 18888:18888
    restart: unless-stopped
  ord:
    build:
      dockerfile: docker/Dockerfile.ord
      context: ./
    image: ord:alkanes
    environment:
      CHAIN: regtest
      RPCUSER: bitcoinrpc
      RPCPASSWORD: bitcoinrpc
      PORT: 8090
      DAEMON_RPC_ADDR: bitcoind:18443
    ports:
      - 8090:8090
    restart: unless-stopped
  metashrew-view:
    build:
      dockerfile: docker/Dockerfile.view
      context: ./
    image: metashrew-view:alkanes
    environment:
      REDIS_URL: redis://keydb:6379
      HOST: 0.0.0.0
      LOG_FILTERS: none,metashrew_keydb_view=debug
    ports:
      - 8080:8080
    restart: unless-stopped
  esplora:
    build:
      dockerfile: docker/Dockerfile.electrs
      context: ./
    image: esplora:alkanes
    volumes:
      - bitcoin-data:/data/bitcoin
    environment:
      ELECTRS_AUTH: bitcoinrpc:bitcoinrpc
      ELECTRS_NETWORK: regtest
      ELECTRS_DAEMON_RPC_ADDR: bitcoind:18443
      ELECTRS_HTTP_ADDR: 0.0.0.0:50010
      ELECTRS_DB_DIR: /data/electrs
      ELECTRS_DAEMON_DIR: /data/bitcoin
    restart: unless-stopped
